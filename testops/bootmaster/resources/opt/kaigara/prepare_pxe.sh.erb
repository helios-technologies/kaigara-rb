#!/bin/bash

set -xe

echo "LANG='en_US.UTF-8'" >  /etc/default/locale

locale-gen 'en_US.UTF-8'

apt-get update
apt-get -y install syslinux
apt-get -y install nfs-kernel-server
apt-get -y install initramfs-tools
apt-get -y install dnsmasq

cp <%= KAI_HOME %>/resources/etc/dnsmasq.d/pxe.conf /etc/dnsmasq.d/
cp <%= KAI_HOME %>/resources/etc/dnsmasq.d/nameserver.conf /etc/dnsmasq.d/

#prepare tftp
mkdir -p /srv/tftpboot/pxelinux.cfg
cp /usr/lib/syslinux/pxelinux.0 /srv/tftpboot/
cp  <%= KAI_HOME %>/resources/srv/tftpboot/pxelinux.cfg/default /srv/tftpboot/pxelinux.cfg/default

#NFS Service
mkdir -p /srv/nfsroot
echo '/srv/nfsroot  10.64.4.0/24(rw,no_root_squash,async,insecure)' >> /etc/exports

#Activate gateway
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
echo 'net.ipv4.conf.default.forwarding = 1' >> /etc/sysctl.conf
echo 'net.ipv4.conf.all.forwarding = 1' >> /etc/sysctl.conf
sysctl -p

service dnsmasq restart
service nfs-kernel-server restart
